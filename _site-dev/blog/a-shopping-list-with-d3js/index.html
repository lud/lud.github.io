<!doctype html>
<meta charset="utf-8">
<title>Make a shopping list app with D3js</title>
<meta name="description" content=""/>


<link rel="stylesheet" type="text/css" href="http://localhost:4000/bootstrap-no-typo/css/bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="http://localhost:4000/css/pygments.css"/>
<link rel="stylesheet" type="text/css" href="http://localhost:4000/css/main.css"/>
<link rel="stylesheet" type="text/css" href="http://localhost:4000/css/fonts.css"/>
<link rel="stylesheet/less" type="text/css" href="http://localhost:4000/css/typo.less" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
<![endif]-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://localhost:4000/bootstrap-no-typo/js/bootstrap.min.js"></script>
<script src="http://localhost:4000/js/less-1.6.0.min.js"></script>

<script>
    $(function(){
        // less.watch();
    })
</script>



<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="http://localhost:4000/">Lud</a>
  </div>

  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">
      <li><a href="http://localhost:4000/">Home</a></li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Last Posts<b class="caret"></b></a>
        <ul class="dropdown-menu">
          
            
                <li><a href="/blog/gerer-les-librairies-erlang-globales/">Des libraries Erlang globales</a></li>
            
          
            
                <li><a href="/blog/a-shopping-list-with-d3js/">Make a shopping list app with D3js</a></li>
            
          
        </ul>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li><a href="https://github.com/lud/lud.github.io">Source</a></li>
    </ul>
    <form class="navbar-form navbar-right" role="search">
      <button id="onlycode" class="btn btn-default">Toggle text</button>
    </form>
  </div><!-- /.navbar-collapse -->
</nav>










<div class="container global">
    <div class="post-content">
        <h1>A shopping list with D3js</h1>

<p>D3js is a fantastic tool to work with graphics in javascript. But here
I want to show that it's also excellent to do whatever you want as
long as you have <strong>data</strong>. Most of applications on the internet use
"views", as in MVC, or MVVM, etc. I bet that if you have a "view"
somewhere, it's worth to try D3.</p>

<p>To follow this tutorial, you must be able to read and write javascript
code and know how to use D3 data joins, mainly the <code>.selectAll(...)</code>,
<code>.data(...)</code>, <code>.enter()</code>, <code>.exit()</code>, etc. functions, and know what functions
passed to <code>.attr(...)</code> receive as parameters. My code here is really
not hard but I do not explain theese concepts. (<a href="http://bost.ocks.org/mike/selection/">Some doc
here</a>).</p>

<p>My code is far from perfect, feel free to send comments
<a href="https://gist.github.com/lud/7869565">here</a>, or fork and let me know.</p>

<h2>The shopping list</h2>

<div class="text-center" style="float:right;width:260px;margin-left:50px">
    <iframe src="http://bl.ocks.org/lud/raw/7869565/" width="250" height="550" style="border:none"> </iframe>
    <a href="http://bl.ocks.org/lud/raw/7869565/" target="_blank">Open in a new window.</a>
</div>


<p>This is a simple application I use to manage the goods I have in my
kitchen. At any time I know what I have at home, and what I need to
buy. So, if I am in a grocer's shop because I suddenly want to eat
some chocolate, I can consult this app on my smartphone and buy what I
need else.</p>

<p>It consists of four lists of items, with buttons to move items from
one list to another.</p>

<p>The "Goods to resupply" is the lists of items I miss, those I want to
buy. It's the only list I have to consult on my smartphone so it's on
top of the page.</p>

<p>If I don't want to buy some item when I'm shopping, I can click on
<button class="btn btn-primary btn-xs"><span class="glyphicon
glyphicon-time"></span></button> to send the item to the <code>later</code> list.
It keeps the top list clean, without unneeded items.</p>

<p>When I put some food in my cart, I send the corresponding item to the
<code>incart</code> list with <button class="btn btn-primary btn-xs"><span
class="glyphicon glyphicon-shopping-cart"></span></button>. This is
the "check" button.</p>

<p>Then, the <code>incart</code> list shows what I have on my cart. If suddenly I
don't want a particular item no more, I send it back to the "Goods to
resupply" list with <button class="btn btn-primary btn-xs">   <span
class="glyphicon glyphicon-refresh"></span> </button>.</p>

<p>When I'm done shopping, I send all the items in my cart to the
<code>athome</code> list with <button class="btn btn-primary btn-xs">   <span
class="glyphicon glyphicon-home"></span> </button> and I know that I
have them. Except if my car burns in a car accident, but this
application does not support car accidents ...</p>

<p>Finally, if I eat the last carot at home, I can send "Carots" to the
top with this button : <button class="btn btn-primary btn-xs">   <span
class="glyphicon glyphicon-refresh"></span> </button>.</p>

<p>I use a different web page to add or remove items from the
application. I do this at home on a computer with a wide screen, this
is not implemented yet. We are currently dicussing the mobile part of
the app only.</p>

<p>But I could add a button to create items, and a fifth list called
<code>trash</code> to send items to it and then remove them.</p>

<p>The application misses buttons on lists headers to move all the items
from a list to another ; notably from <code>later</code> to "Goods to resupply"
(Or from <code>athome</code> to the top, call it the car accident button). I did
implement them but I was not happy with the result. The code was very
short but the look and feel was not good.</p>

<h2>How we make it ?</h2>

<p>It's time to talk about code. We will see now how do we build this
simple list application with a relative small amount of code, thanks
to the expressiveness of both javascript and D3js.</p>

<p>This tutorial is just the real code with some comments between each
parts of it. You can see all of the HTML and javascript code
<a href="http://bl.ocks.org/lud/7869565">here</a>.</p>

<p>We do not talk about server side here, there is no AJAX code, but as
soon as an item is moved to one list, it should be updated on the
server. (Or put in a queue that send updates and retries when the shop
building is too thick for the waves !).</p>

<p><strong>Update:</strong> I like short variable names, but it can be confusing for
some readers. I speak a lot about <code>n</code> and <code>s</code> properties. Think
about them in terms of <code>name</code> and <code>id/status_id</code> (list section), respectively.</p>

<h3>Data</h3>

<p>First we have some lists specifications. In a real world app, this
would come from the server.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">listspecs</span> <span class="o">=</span>
        <span class="p">[</span> <span class="p">{</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;resupply&#39;</span>
          <span class="p">,</span> <span class="nx">s</span><span class="o">:</span> <span class="mi">1</span>
          <span class="p">,</span> <span class="nx">wf</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;later&#39;</span><span class="p">,</span> <span class="s1">&#39;incart&#39;</span><span class="p">]</span>
          <span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;Goods to resupply&#39;</span>
          <span class="p">,</span> <span class="nx">icon</span><span class="o">:</span> <span class="s1">&#39;refresh&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;later&#39;</span>
          <span class="p">,</span> <span class="nx">s</span><span class="o">:</span> <span class="mi">2</span>
          <span class="p">,</span> <span class="nx">wf</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;incart&#39;</span><span class="p">]</span>
          <span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
          <span class="p">,</span> <span class="nx">icon</span><span class="o">:</span> <span class="s1">&#39;time&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;incart&#39;</span>
          <span class="p">,</span> <span class="nx">s</span><span class="o">:</span> <span class="mi">3</span>
          <span class="p">,</span> <span class="nx">wf</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;resupply&#39;</span><span class="p">,</span> <span class="s1">&#39;athome&#39;</span><span class="p">]</span>
          <span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
          <span class="p">,</span> <span class="nx">icon</span><span class="o">:</span> <span class="s1">&#39;shopping-cart&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;athome&#39;</span>
          <span class="p">,</span> <span class="nx">s</span><span class="o">:</span> <span class="mi">4</span>
          <span class="p">,</span> <span class="nx">wf</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;resupply&#39;</span><span class="p">]</span>
          <span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
          <span class="p">,</span> <span class="nx">icon</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span>
          <span class="p">}</span>
        <span class="p">];</span>
</code></pre></div>


<p>Theese specifiactions are objects with the following members :</p>

<ul>
<li><code>n</code> is the simple name of the list. It must be a valid unique
identifier because it's used as function names and CSS
classes. CSS classes cannot contain spaces.</li>
<li><code>s</code> is a numeric identifier. The list items do not store the list
name but this numeric value, which is more small/efficient. 's' stands
for status, the status of an item, it's current list.</li>
<li><code>wf</code> is a list of the workflow targets i.e. the <code>n</code> of the
other lists an item from this list can be moved to.</li>
<li><code>label</code> is a label ... a display text.</li>
<li><code>icon</code> is an identifier for an image. This could be a
filename or anything. Here we use Twitter Bootstrap and
it's Glyphicons. So this is a "glyphicon-" prefixed CSS
class name.</li>
</ul>


<p>Then we have some items, they would come from the server too :</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">allItems</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Apples&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Carots&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Grapes&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Pears&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Bananas&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Potatoes&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;Ice Cream&#39;</span><span class="p">}</span>
                   <span class="p">,</span> <span class="p">{</span><span class="nx">s</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">:</span> <span class="s1">&#39;a new Laptop&#39;</span><span class="p">}</span>
                   <span class="p">];</span>
</code></pre></div>


<p><code>n</code> is the name of the item, and <code>s</code> shows in which lists the item is
when we load the page. This <code>s</code> property matches with the lists' <code>s</code>
property.</p>

<p>Finally, we want to display multiple lists of items. D3 likes data as
lists, so we will create as many lists (Arrays) as there are lists
specs. For the moment, let's declare a simple object to associate
lists names (resupply, later, ...) with actual Arrays.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">lists</span> <span class="o">=</span> <span class="p">{};</span>
</code></pre></div>


<h3>Manipulate the data</h3>

<p>Now we need some tools to access data in a convenient manner.</p>

<p>We define a function to reference a spec from its <code>n</code> or it's <code>s</code>.
<code>listspecs</code> is an array, if we want to retrieve a list specification
in this array, we must know the index of the element in it. For each
list spec, we associate it's <code>s</code> property with it's index, and it's
<code>n</code> property with it's index too, in a registry variable (<code>listReg</code>).
Now, we can retrieve a list specification index from it's <code>n</code> or <code>s</code>,
and acces the right entry in the array, in the defined function.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">getListSpec</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">listReg</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">listspecs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span>
            <span class="nx">listReg</span><span class="p">[</span><span class="nx">ls</span><span class="p">.</span><span class="nx">s</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="nx">listReg</span><span class="p">[</span><span class="nx">ls</span><span class="p">.</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">listspecs</span><span class="p">[</span><span class="nx">listReg</span><span class="p">[</span><span class="nx">x</span><span class="p">]];</span>
        <span class="p">}</span>
    <span class="p">}());</span>
</code></pre></div>


<p>We define a function to get the actual list (Array object) with the
same arguments : <code>s</code> or <code>n</code>, or a listspec object.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">function</span> <span class="nx">getList</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">n</span> <span class="o">||</span> <span class="nx">getListSpec</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">n</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">lists</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div>


<p>Let's define a simple constructor (class-like) to add methods to our
items. An item can remove itself from a list (<code>degroup</code>), add itself
to a list (<code>addTo</code>) and keep a reference to it (<code>this.list</code>). The
first call to addTo is made within the constructor. addTo uses the <code>s</code>
of a list. The current implementation works if we send a list's <code>n</code> but
we may send to a sever our changes, so we should stick with one value-
type only.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">Item</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">itemSpec</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="nx">itemSpec</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">itemSpec</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">itemSpec</span><span class="p">.</span><span class="nx">s</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">Item</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">degroup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">Item</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">getList</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
        <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">};</span>
</code></pre></div>


<p>Now, for each existing spec, we will create an entry in the <code>lists</code>
object, and add to the list a reference to it's spec. We will also
define methods to the Item prototype to allow us to send an item to a
specific list. After this code, we can call <code>(new
Item({...})).resupply();</code>.</p>

<div class="highlight"><pre><code class="javascript">    <span class="nx">listspecs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span>
        <span class="nx">lists</span><span class="p">[</span><span class="nx">ls</span><span class="p">.</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">lists</span><span class="p">[</span><span class="nx">ls</span><span class="p">.</span><span class="nx">n</span><span class="p">].</span><span class="nx">spec</span> <span class="o">=</span> <span class="nx">ls</span><span class="p">;</span>
        <span class="nx">Item</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">ls</span><span class="p">.</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">degroup</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">s</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">});</span>
</code></pre></div>


<p>Finally, for each item in our <code>allItems</code> list, we create an <code>Item</code>
object. Since in it's constructor, an Item add itself to the right
list, there is nothing more to handle here.</p>

<div class="highlight"><pre><code class="javascript">    <span class="nx">allItems</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">){</span>
        <span class="k">new</span> <span class="nx">Item</span><span class="p">(</span><span class="nx">spec</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre></div>


<p>Our data is now ready. Just <code>console.log(lists);</code>.</p>

<h3>Display the data with D3</h3>

<p>We will use our lists specs as data to display the lists headers and
create lists items containers (<code>&lt;ul/&gt;</code>). Then, for each list, we will
append our list items (<code>&lt;li/&gt;</code>) to theese containers.</p>

<p>First, we select our wrapper and then do a data join with <code>.selectAll</code>
and <code>.data</code>. We supply the lists specifications as data. We will call this
elements a 'group' : a header and the items.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#lists&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;div.group&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">listspecs</span><span class="p">);</span>
</code></pre></div>


<p>We create the groups wrappers : the same elements that we
targeted in <code>selectAll()</code>.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">newgroup</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">);</span>
</code></pre></div>


<p>Then we append to theese groups the header, a <code>div</code> element with the
list icon, the list label (or the list <code>n</code> if the label is falsy (as
is an empty list)), and an empty span which will display the number of
items in the list.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">var</span> <span class="nx">grouphead</span> <span class="o">=</span> <span class="nx">newgroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;grouphd&#39;</span><span class="p">);</span>
    <span class="nx">grouphead</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span> <span class="k">return</span> <span class="nx">clicon</span><span class="p">(</span><span class="nx">ls</span><span class="p">.</span><span class="nx">icon</span><span class="p">)</span> <span class="p">})</span>
    <span class="nx">grouphead</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span> <span class="k">return</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">label</span> <span class="o">||</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">n</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;list-name&#39;</span><span class="p">)</span>
    <span class="nx">grouphead</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;list-len&#39;</span><span class="p">)</span>
</code></pre></div>


<p>And then, a <code>&lt;ul/&gt;</code> tag with the lists <code>n</code> property as an id</p>

<div class="highlight"><pre><code class="javascript">    <span class="nx">newgroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span> <span class="k">return</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">n</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;list list-unstyled&#39;</span><span class="p">);</span>
</code></pre></div>


<p>It's time to display our list items. We will define a function
<code>render</code>, and call it every time the data is updated (when an item is
moved). Our the data-join between <code>div.group</code> (elements) and
<code>listspecs</code> (data) exists forever (as long as we do not make a new
join on the same elements). As the data changes, we can update our
elements.</p>

<p>First, we update the item count on each list header</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">function</span> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">group</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;.list-len&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span> <span class="k">return</span> <span class="s1">&#39; (&#39;</span><span class="o">+</span><span class="nx">getList</span><span class="p">(</span><span class="nx">ls</span><span class="p">).</span><span class="nx">length</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="p">});</span>
        <span class="nx">group</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span>
</code></pre></div>


<p>The D3 function <code>.each()</code> allow to work with only a group at a time.
it provides us the ability to use closures.</p>

<p>We make a data-join on our <code>&lt;li/&gt;</code> elements and our items. The key are
item's <code>n</code> property. When calling <code>group.each(function(){ ... })</code>,
inside the function, <code>this</code> refers to the current group's DOM element.</p>

<div class="highlight"><pre><code class="javascript">            <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">getList</span><span class="p">(</span><span class="nx">ls</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">li</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;ul&#39;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">n</span> <span class="p">});</span>
</code></pre></div>


<p>We remove the old entries which aren't in the list no more</p>

<div class="highlight"><pre><code class="javascript">            <span class="nx">li</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
</code></pre></div>


<p>If the current list is empty, we display a paragraph to inform the
user. We also stop execution of the function since all further code is
related to items but this is not mandatory.</p>

<p>If the list is not empty, we select any possible paragraph existing
and remove it. We do this before adding the paragraph on an empty
list.</p>

<div class="highlight"><pre><code class="javascript">            <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;p.empty&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;empty&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;Nothing here&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
</code></pre></div>


<p>Now we are only concerned with the new entries in the list, since the
items that doesn't change persist in the DOM. On the first rendering,
all items are new.</p>

<p>So, on our new items, let's create a <code>&lt;li/&gt;</code> element. We append a
<code>&lt;span/&gt;</code> element whose text will be the item name (<code>n</code> property).</p>

<div class="highlight"><pre><code class="javascript">            <span class="kd">var</span> <span class="nx">newli</span> <span class="o">=</span> <span class="nx">li</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">);</span>
            <span class="nx">newli</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="nx">x</span><span class="p">){</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">n</span> <span class="p">});</span>
</code></pre></div>


<p>At this point, we can see the items. If you don't need buttons, you're
done.</p>

<p>But we want to be able to move an item from a list to another, but
only following workflow rules. We will now append as much buttons as
there are target lists in the <code>wf</code> property of our current list spec.
We just append a wrapper for theese buttons and pass this new element
to a function thanks to the d3 function <code>.call()</code>.</p>

<div class="highlight"><pre><code class="javascript">            <span class="nx">newli</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;ctrl&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">wrapper</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div>


<p>The callback is sent the selection of all the wrapper for the current
list. This is a d3 selection, so we can use it as if it was a single
element <code>&lt;div/&gt;</code>. It is called only once per group.</p>

<p>We have added functions such as <code>resupply()</code> and <code>later()</code> to the
<code>Item.prototype</code>. There we iterate on the <code>wf</code> property of the
current list spec, which contain the same names. So, for each other
list an item can be sent to, we just register a listener for the
<code>click</code> event which call this function on the <code>Item</code> instance.</p>

<p>When we click on a button, the item is moved to another list, so data
changes. We need to call <code>render()</code> again to update our elements.</p>

<p>Finally, the button is empty, so we append a <code>span</code> with a <code>class</code>
attribute containing what Bootstrap needs to display a Glyphicon. See
the <code>clicon</code> function below.</p>

<div class="highlight"><pre><code class="javascript">                    <span class="nx">ls</span><span class="p">.</span><span class="nx">wf</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">){</span>
                        <span class="nx">wrapper</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;btn btn-primary btn-xs&#39;</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span>
                                <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                                <span class="nx">d</span><span class="p">[</span><span class="nx">n</span><span class="p">]();</span>
                                <span class="nx">render</span><span class="p">();</span>
                            <span class="p">})</span>
                            <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="nx">clicon</span><span class="p">(</span><span class="nx">getListSpec</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">icon</span><span class="p">))</span>
                    <span class="p">});</span>
                <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">}</span>
</code></pre></div>


<p>This is a helper function to transform an icon name into a glyphicon
class.</p>

<div class="highlight"><pre><code class="javascript">    <span class="kd">function</span> <span class="nx">clicon</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;glyphicon glyphicon-&#39;</span><span class="o">+</span><span class="nx">i</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>


<p>Now, let's simply call <code>render()</code> "manually" to trigger the first
display.</p>

<div class="highlight"><pre><code class="javascript">    <span class="nx">render</span><span class="p">();</span>
</code></pre></div>


<p>And we're done ! Thanks for reading.</p>

        
    <p class="visible-xs">Bootstrap Layout : <b>X Small</b></p>
    <p class="visible-sm">Bootstrap Layout : <b>Small</b></p>
    <p class="visible-md">Bootstrap Layout : <b>Medium</b></p>
    <p class="visible-lg">Bootstrap Layout : <b>Large</b></p>

        <p>Tags : d3js </p>
    </div>
</div>


<script>
    $(function(){
        $('#onlycode').on('click', function(evt) {
            evt.preventDefault();
            $('.global').toggleClass('onlycode');
        });
    });
</script>
